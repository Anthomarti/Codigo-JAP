<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Código JAP - Anthomarti</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #121212; color: #eee; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    a { color: #58a6ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { max-width: 880px; margin-top: 48px; }
    .folder { padding: 10px 0; border-bottom: 1px solid #2b2b2b; display: flex; justify-content: space-between; gap: 12px; }
    .muted { color: #9aa0a6; font-size: .9rem; }
    .loading { text-align: center; margin-top: 2rem; font-style: italic; color: #9aa0a6; }
    .badge-ok{ background:#198754; }
    .badge-miss{ background:#6c757d; }
    .small-err{ font-size:.9rem; color:#ffb4b4 }
    code { color:#ffc107 }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-2 text-center">Repositorio: <span class="text-info">Código JAP</span></h1>
    <p class="text-center muted">
      Lista auto-generada con enlaces a <b>index.html</b> de cada carpeta.
    </p>

    <div id="fileList" class="mt-4"></div>
    <div id="loading" class="loading">Cargando lista de carpetas…</div>

    <div class="mt-4 muted">
      <details>
        <summary>¿Error de API / repo privado? Opcional: usar token</summary>
        <p class="mt-2">
          Podés pasar un token personal de GitHub en la URL como <code>?token=ghp_xxx</code>
          (solo lectura). Ayuda si el repo es privado o si superaste el límite anónimo (60 req/h).
        </p>
      </details>
    </div>
  </div>

  <script>
    // === Configurá estos valores ===
    const username = "Anthomarti";
    const repo     = "Codigo-JAP";   // ¡respetá mayúsculas/minúsculas del repo!
    const branch   = "";             // ej. "main" o "master" (vacío = default)

    // Token opcional desde query (?token=ghp_xxx) para evitar rate-limit o acceder a repos privados
    const token = new URL(location.href).searchParams.get("token") || "";

    const headers = {
      "Accept": "application/vnd.github+json"
      // "User-Agent" no se puede setear desde el navegador; ya hay uno del browser
    };
    if (token) headers["Authorization"] = `Bearer ${token}`;

    const apiBase = `https://api.github.com/repos/${username}/${repo}/contents`;

    async function getRepoContent(path = "") {
      const ref = branch ? `?ref=${encodeURIComponent(branch)}` : "";
      const url = `${apiBase}/${encodeURIComponent(path).replace(/%2F/g,'/')}${path ? ref : ref}`;
      const res = await fetch(url, { headers });

      if (!res.ok) {
        // Intentamos leer mensaje de GitHub (rate limit, not found, etc.)
        let msg = `HTTP ${res.status}`;
        try {
          const json = await res.json();
          if (json && json.message) msg += ` — ${json.message}`;
        } catch (_) {}
        throw new Error(msg);
      }
      return res.json();
    }

    async function generateList() {
      const container = document.getElementById("fileList");
      const loading   = document.getElementById("loading");

      try {
        const root = await getRepoContent("");               // lista raíz
        const folders = root.filter(it => it.type === "dir");

        if (!folders.length) {
          container.innerHTML = "<p class='muted'>No hay carpetas en el repositorio.</p>";
          return;
        }

        const list = document.createElement("ul");
        list.className = "list-unstyled";

        // Buscamos en paralelo el contenido de cada carpeta (una capa)
        const inspections = await Promise.allSettled(
          folders.map(async (folder) => {
            const sub = await getRepoContent(folder.path);
            const hasIndex = sub.some(f => f.name === "index.html");
            return { folder, hasIndex };
          })
        );

        inspections.forEach((result, i) => {
          const li = document.createElement("li");
          li.className = "folder";

          if (result.status === "fulfilled") {
            const { folder, hasIndex } = result.value;
            li.innerHTML = hasIndex
              ? `<span><a href="./${encodeURIComponent(folder.name)}/index.html" target="_blank">${folder.name}</a></span>
                 <span class="badge badge-ok">index.html</span>`
              : `<span>${folder.name}</span>
                 <span class="badge badge-miss">sin index.html</span>`;
          } else {
            const folder = folders[i];
            li.innerHTML = `
              <span>${folder.name}</span>
              <span class="small-err">error: ${result.reason.message}</span>
            `;
          }
          list.appendChild(li);
        });

        container.innerHTML = "";
        container.appendChild(list);

      } catch (err) {
        document.getElementById("fileList").innerHTML =
          `<p class="text-danger">Error al obtener contenido: <code>${err.message}</code></p>
           <p class="muted">Verificá: nombre de repo/usuario, si el repo es privado, el branch (<code>${branch||'default'}</code>) y el límite de la API.</p>`;
      } finally {
        loading.remove();
      }
    }

    generateList();
  </script>
</body>
</html>
